# 要件定義書 — 楽天検索順位取得ツール

| 項目 | 内容 |
|---|---|
| ドキュメントバージョン | 1.0 |
| 作成日 | 2026-02-26 |
| ステータス | ドラフト |

---

## 1. プロジェクト目的

楽天市場の検索結果における自社・競合商品の掲載順位を定期的に自動取得し、
順位推移の可視化と CSV エクスポートにより、SEO 施策の効果測定を支援する。

---

## 2. システム構成図

```
[Windows タスクスケジューラ]
        │  2時間おき（1日12回）
        ▼
[Python Collector]
  requests + BeautifulSoup
  PC用 / SP用 の User-Agent で取得
        │
        ▼
[Supabase (PostgreSQL)]
        │
        ▼
[Next.js Dashboard]
  順位一覧 / グラフ / CSV ダウンロード
```

---

## 3. 機能要件

### 3.1 データ収集（collector）

| ID | 機能 | 詳細 |
|---|---|---|
| C-01 | キーワード検索 | `https://search.rakuten.co.jp/search/mall/{keyword}/` にアクセスし HTML を取得 |
| C-02 | デバイス別取得 | PC / SP それぞれの User-Agent でリクエストを送信 |
| C-03 | 商品順位特定 | 検索結果の商品リンクから `shop_url` + `product_id` を抽出し、登録商品と照合 |
| C-04 | 順位記録 | 一致した商品の表示順位（1〜45）を記録。見つからない場合は `null`（圏外） |
| C-05 | 自店舗ヒット数 | 指定キーワードの検索結果1ページ目に、登録した各店舗（shop_url）の商品が何件表示されているかをカウント |
| C-06 | 定期実行 | Windows タスクスケジューラで 2 時間間隔（1日12回）実行 |
| C-07 | リクエスト間隔 | 各リクエスト間に 1〜3 秒のランダムインターバル（`random.uniform(1, 3)`） |
| C-08 | エラーハンドリング | HTTP エラー・タイムアウト時はログ出力し、該当キーワードをスキップして継続 |

### 3.2 ダッシュボード（dashboard）

| ID | 機能 | 詳細 |
|---|---|---|
| D-01 | 商品一覧表示 | 登録済み商品をリスト表示。各商品に紐付くキーワードを表示 |
| D-02 | 検索・絞り込み | 上部の検索フォームでキーワード・商品の絞り込み |
| D-03 | 順位一覧 | 登録条件ごとに PC / SP の検索順位を一覧表示 |
| D-04 | 変動フィルタ | 順位の上昇・下降・停滞で商品を絞り込み表示 |
| D-05 | 順位推移グラフ | 収集した検索順位の推移を折れ線グラフで表示 |
| D-06 | 商品詳細ダッシュボード | 商品リストをクリックすると詳細ダッシュボードを表示 |
| D-07 | CSV ダウンロード | 表示中のデータを CSV 形式でダウンロード |
| D-08 | 他社比較 | 同一キーワードでの自社 vs 他社商品の順位比較表示 |

### 3.3 商品・キーワード管理

| ID | 機能 | 詳細 |
|---|---|---|
| M-01 | 商品登録 | `shop_url` + `product_id`（商品管理番号）を登録 |
| M-02 | キーワード登録 | 商品に対して複数キーワードを紐付けて登録 |
| M-03 | 多対多リレーション | 1商品に複数キーワード、1キーワードに複数商品（自社+他社）を紐付け可能 |
| M-04 | 新規登録フォーム | 「＋」ボタンから商品管理番号 + キーワードを入力して登録 |
| M-05 | 編集・削除 | 登録済みの商品・キーワードの編集と削除 |

---

## 4. 非機能要件

| 項目 | 要件 |
|---|---|
| 対応ページ数 | Phase 1: 1ページ目（45件）のみ。Phase 2 以降: 2〜3ページに拡張 |
| データ保持期間 | 当面制限なし（Supabase 無料枠の範囲で運用） |
| 認証 | Phase 1: なし。Phase 2 以降: Supabase Auth |
| 可用性 | ローカル PC 運用のため SLA なし。PC 起動中のみ動作 |
| セキュリティ | API キー等は `.env` で管理。`.gitignore` に含める |
| スクレイピング配慮 | リクエスト間隔 1〜3 秒ランダム |

---

## 5. データモデル（概念設計）

### 5.1 ER 図

```
products            product_keywords          keywords
┌──────────────┐    ┌──────────────────┐    ┌──────────────┐
│ id (PK)      │    │ id (PK)          │    │ id (PK)      │
│ shop_url     │───<│ product_id (FK)  │>───│ keyword      │
│ product_id   │    │ keyword_id (FK)  │    │ created_at   │
│ display_name │    │ created_at       │    └──────────────┘
│ created_at   │    └──────────────────┘
│ updated_at   │
└──────────────┘
        │
        ▼
rankings
┌──────────────────┐
│ id (PK)          │
│ product_id (FK)  │
│ keyword_id (FK)  │
│ device (pc/sp)   │
│ rank (nullable)  │  ← null = 圏外
│ page             │  ← 将来の複数ページ対応
│ searched_at      │
│ created_at       │
└──────────────────┘

shop_hit_counts
┌──────────────────┐
│ id (PK)          │
│ keyword_id (FK)  │
│ shop_url         │
│ device (pc/sp)   │
│ hit_count        │
│ searched_at      │
│ created_at       │
└──────────────────┘
```

### 5.2 テーブル定義

#### products（商品マスタ）
| カラム | 型 | 説明 |
|---|---|---|
| id | uuid (PK) | 自動生成 |
| shop_url | text NOT NULL | 店舗URL識別子（例: `ichiban-okinawa`） |
| product_id | text NOT NULL | 商品管理番号（例: `noni-jyuce3`） |
| display_name | text | 表示名（任意。管理しやすくするため） |
| created_at | timestamptz | 登録日時 |
| updated_at | timestamptz | 更新日時 |
| **UNIQUE** | | `(shop_url, product_id)` |

#### keywords（キーワードマスタ）
| カラム | 型 | 説明 |
|---|---|---|
| id | uuid (PK) | 自動生成 |
| keyword | text NOT NULL UNIQUE | 検索キーワード |
| created_at | timestamptz | 登録日時 |

#### product_keywords（商品×キーワード 中間テーブル）
| カラム | 型 | 説明 |
|---|---|---|
| id | uuid (PK) | 自動生成 |
| product_id | uuid (FK) | → products.id |
| keyword_id | uuid (FK) | → keywords.id |
| created_at | timestamptz | 登録日時 |
| **UNIQUE** | | `(product_id, keyword_id)` |

#### rankings（順位記録）
| カラム | 型 | 説明 |
|---|---|---|
| id | uuid (PK) | 自動生成 |
| product_id | uuid (FK) | → products.id |
| keyword_id | uuid (FK) | → keywords.id |
| device | text NOT NULL | `pc` または `sp` |
| rank | integer | 表示順位（1〜45）。圏外は `null` |
| page | integer DEFAULT 1 | 取得ページ番号（将来拡張用） |
| searched_at | timestamptz NOT NULL | 検索実行日時 |
| created_at | timestamptz | レコード作成日時 |

#### shop_hit_counts（店舗ヒット数）
| カラム | 型 | 説明 |
|---|---|---|
| id | uuid (PK) | 自動生成 |
| keyword_id | uuid (FK) | → keywords.id |
| shop_url | text NOT NULL | 店舗URL識別子 |
| device | text NOT NULL | `pc` または `sp` |
| hit_count | integer NOT NULL | 検索結果1ページ目のヒット数 |
| searched_at | timestamptz NOT NULL | 検索実行日時 |
| created_at | timestamptz | レコード作成日時 |

---

## 6. 画面構成

### 6.1 商品一覧画面（トップ）

```
┌─────────────────────────────────────────────────┐
│ [検索フォーム: キーワード / 商品で絞り込み]  [＋新規登録] │
├─────────────────────────────────────────────────┤
│ 商品リスト                                        │
│ ┌─────────────────────────────────────────────┐ │
│ │ ichiban-okinawa/noni-jyuce3                  │ │
│ │ KW: ノニジュース, ノニ, 健康ジュース             │ │
│ │ PC: 3位(↑2) | SP: 5位(↓1) | ヒット: 4件      │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ ichiban-okinawa/goya-tea1                    │ │
│ │ KW: ゴーヤ茶, 沖縄茶                           │ │
│ │ PC: 12位(→) | SP: 圏外 | ヒット: 2件           │ │
│ └─────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│ フィルタ: [全て] [上昇↑] [下降↓] [停滞→] [圏外]    │
└─────────────────────────────────────────────────┘
```

### 6.2 商品詳細ダッシュボード

```
┌─────────────────────────────────────────────────┐
│ ← 戻る    ichiban-okinawa/noni-jyuce3   [CSV出力] │
├───────────────────────┬─────────────────────────┤
│ キーワード別順位一覧     │  順位推移グラフ           │
│ ┌───────┬────┬────┐  │  ┌─────────────────────┐ │
│ │ KW    │ PC │ SP │  │  │  📈 折れ線グラフ       │ │
│ ├───────┼────┼────┤  │  │  X軸: 日時            │ │
│ │ ノニ   │ 3  │ 5  │  │  │  Y軸: 順位（逆順）    │ │
│ │ ノニJS │ 1  │ 2  │  │  │  系列: PC / SP       │ │
│ │ 健康JS │ 圏外│ 12 │  │  │                      │ │
│ └───────┴────┴────┘  │  └─────────────────────┘ │
├───────────────────────┴─────────────────────────┤
│ 他社比較: 「ノニジュース」                          │
│ ┌──────────────────┬────┬────┐                   │
│ │ 商品              │ PC │ SP │                   │
│ ├──────────────────┼────┼────┤                   │
│ │ 自社/noni-jyuce3 │ 3  │ 5  │                   │
│ │ 他社A/noni-001   │ 1  │ 1  │                   │
│ │ 他社B/noni-abc   │ 7  │ 3  │                   │
│ └──────────────────┴────┴────┘                   │
└─────────────────────────────────────────────────┘
```

### 6.3 新規登録モーダル

```
┌─────────────────────────────────┐
│ 商品・キーワード登録              │
├─────────────────────────────────┤
│ 店舗URL:    [ichiban-okinawa  ] │
│ 商品管理番号: [noni-jyuce3     ] │
│ キーワード:  [ノニジュース      ] │
│             [＋ キーワード追加]   │
│                                 │
│       [キャンセル]  [登録]       │
└─────────────────────────────────┘
```

---

## 7. フェーズ分け

### Phase 1（MVP）
- [x] 要件定義（本ドキュメント）
- [ ] DB スキーマ作成（Supabase マイグレーション）
- [ ] Python collector 実装（requests + BeautifulSoup）
- [ ] Windows タスクスケジューラ設定用 bat ファイル
- [ ] Next.js ダッシュボード（一覧・詳細・グラフ・CSV出力）
- [ ] 商品・キーワード CRUD（ダッシュボードから登録・編集・削除）

### Phase 2（拡張）
- [ ] 2〜3ページ目の検索結果取得
- [ ] Supabase Auth によるログイン機能
- [ ] Playwright への切替（必要に応じて）
- [ ] 通知機能（順位変動時のアラート）

---

## 8. 受入条件（Phase 1）

1. 登録した商品・キーワードに対して、PC / SP の検索順位が 2 時間おきに自動取得される
2. ダッシュボードで順位一覧、推移グラフ、他社比較が表示される
3. 上昇・下降・停滞のフィルタリングができる
4. CSV ダウンロードが動作する
5. 商品・キーワードの登録・編集・削除がダッシュボードから行える
6. Windows タスクスケジューラで bat ファイル経由で自動実行できる
